<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Brady TTS - Free AI Voice Generator</title>
  
  <!-- Preconnect to CDNs for faster loading -->
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://huggingface.co">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --secondary: #ec4899;
      --card-bg: rgba(255, 255, 255, 0.9);
      --text-main: #1f2937;
      --text-muted: #6b7280;
      --border: #e5e7eb;
      --shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1);
      --radius: 16px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Outfit', sans-serif;
      background: #f8fafc;
      background-image:
        radial-gradient(at 0% 0%, hsla(253, 16%, 7%, 1) 0, transparent 50%),
        radial-gradient(at 50% 0%, hsla(225, 39%, 30%, 1) 0, transparent 50%),
        radial-gradient(at 100% 0%, hsla(339, 49%, 30%, 1) 0, transparent 50%);
      background-size: 100% 100vh;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-main);
      padding: 20px;
    }

    /* GPU-Accelerated Background */
    .blob { position: absolute; filter: blur(80px); z-index: -1; opacity: 0.6; animation: float 10s infinite ease-in-out; will-change: transform; }
    .blob-1 { top: 10%; left: 10%; width: 300px; height: 300px; background: #818cf8; border-radius: 40% 60% 70% 30%; }
    .blob-2 { bottom: 10%; right: 10%; width: 350px; height: 350px; background: #f472b6; border-radius: 60% 40% 30% 70%; animation-delay: -5s; }

    @keyframes float { 0%, 100% { transform: translateY(0) scale(1); } 50% { transform: translateY(-20px) scale(1.05); } }

    header { width: 100%; max-width: 800px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding: 0 10px; }
    .brand { display: flex; align-items: center; gap: 12px; font-size: 1.5rem; font-weight: 700; color: white; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); }
    .brand i { color: #fbbf24; }

    /* Easy Instructions Box */
    .instructions {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      color: white;
      padding: 1rem 1.5rem;
      border-radius: var(--radius);
      width: 100%;
      max-width: 800px;
      margin-bottom: 1.5rem;
      font-size: 0.95rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }
    .instructions strong { font-size: 1.05rem; display: block; margin-bottom: 8px; color: #fbbf24; }
    .instructions ol { margin-left: 20px; line-height: 1.6; }

    .app-container {
      background: var(--card-bg); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.5);
      border-radius: var(--radius); box-shadow: var(--shadow); width: 100%; max-width: 800px; padding: 2rem;
      display: grid; grid-template-columns: 1fr 300px; gap: 2rem;
    }

    .input-section { display: flex; flex-direction: column; gap: 1rem; }
    .input-header { display: flex; justify-content: space-between; align-items: center; }
    .char-count { font-size: 0.85rem; color: var(--text-muted); background: rgba(0, 0, 0, 0.05); padding: 4px 8px; border-radius: 6px; }

    textarea {
      width: 100%; height: 250px; border: 2px solid var(--border); border-radius: 12px; padding: 1rem;
      font-family: inherit; font-size: 1rem; resize: none; outline: none; background: rgba(255, 255, 255, 0.5);
      will-change: border-color; transition: border-color 0.2s;
    }
    textarea:focus { border-color: var(--primary); background: white; }

    .controls-section { display: flex; flex-direction: column; gap: 1.5rem; border-left: 1px solid var(--border); padding-left: 2rem; }
    .control-group { display: flex; flex-direction: column; gap: 0.5rem; }
    label { font-size: 0.85rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; }

    select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: white; font-family: inherit; outline: none; cursor: pointer; font-size: 0.95rem; }
    select:focus { border-color: var(--primary); }

    .action-btn {
      margin-top: auto; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white;
      border: none; padding: 1rem; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.3s ease;
      will-change: transform, box-shadow;
    }
    .action-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6); }
    .action-btn:disabled { opacity: 0.7; cursor: not-allowed; transform: none; box-shadow: none; }

    .visualizer-container {
      margin-top: 2rem; background: rgba(0, 0, 0, 0.03); border-radius: 12px; padding: 1rem; height: 80px;
      display: flex; align-items: center; justify-content: center; gap: 4px; overflow: hidden;
    }
    
    .bar { width: 6px; background: var(--primary); border-radius: 4px; height: 10px; will-change: transform; }
    .visualizer-container.active .bar { animation: bounce 1s infinite ease-in-out; }
    @keyframes bounce { 
        0%, 100% { transform: scaleY(1); } 
        50% { transform: scaleY(4); background: var(--secondary); } 
    }
    .bar:nth-child(odd) { animation-duration: 0.8s; } .bar:nth-child(even) { animation-duration: 1.1s; }

    .status-msg { text-align: center; font-size: 0.9rem; color: var(--text-muted); margin-top: 10px; min-height: 20px; font-weight: 600; }
    
    .spinner { width: 20px; height: 20px; border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: white; animation: spin 1s linear infinite; display: none; will-change: transform; }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 768px) {
      .app-container { grid-template-columns: 1fr; padding: 1.5rem; }
      .controls-section { border-left: none; border-top: 1px solid var(--border); padding-left: 0; padding-top: 1.5rem; }
    }
  </style>
</head>

<body>
  <div class="blob blob-1"></div>
  <div class="blob blob-2"></div>

  <header>
    <div class="brand"><i class="fas fa-bolt"></i><span>Brady TTS</span></div>
  </header>

  <!-- Friendly How-To Guide -->
  <div class="instructions">
    <strong>üëã How to use this app:</strong>
    <ol>
      <li>Type whatever you want the AI to say in the text box.</li>
      <li>Pick a voice from the menu on the right.</li>
      <li>Click <b>Generate Speech</b>! <i>(The ultra-realistic voices take a minute to download the first time you use them).</i></li>
    </ol>
  </div>

  <main class="app-container">
    <section class="input-section">
      <div class="input-header">
        <label for="text-input" style="color: var(--text-main); font-size: 1.1rem;">Enter Text</label>
        <span class="char-count" id="char-count">0 / 500</span>
      </div>
      <textarea id="text-input" placeholder="Type something here to hear it out loud..."></textarea>
      <div class="visualizer-container" id="visualizer"></div>
      <div class="status-msg" id="status-msg">Waiting for text...</div>
    </section>

    <section class="controls-section">
      <div class="control-group">
        <label>Choose a Voice</label>
        <select id="engine-select">

          <optgroup label="üåü Ultra-Realistic Voices (Best Quality)">
            <option value="kokoro_af_bella">American Woman (Bella)</option>
            <option value="kokoro_am_adam">American Man (Adam)</option>
            <option value="kokoro_bf_emma">British Girl (Emma)</option>
            <option value="kokoro_bm_george">British Boy (George)</option>
          </optgroup>

          <optgroup label="‚òÅÔ∏è Fast Cloud Voices (Best for School Wi-Fi)">
            <option value="twitch_Justin">Boy Voice (Justin)</option>
            <option value="twitch_Ivy">Girl Voice (Ivy)</option>
            <option value="twitch_Matthew">Man Voice (Matthew)</option>
            <option value="twitch_Salli">Woman Voice (Salli)</option>
          </optgroup>

          <optgroup label="üåç International Voices">
            <option value="mms_Xenova/mms-tts-eng">Standard English</option>
            <option value="mms_Xenova/mms-tts-spa">Standard Spanish</option>
            <option value="mms_Xenova/mms-tts-fra">Standard French</option>
          </optgroup>

          <optgroup label="üîå Device Default">
            <option value="native">Basic Computer Voice (Offline)</option>
          </optgroup>
        </select>
        
        <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 6px; line-height: 1.4;">
          <strong>Tip:</strong> If the üåü Realistic voices won't load on your school network, use the ‚òÅÔ∏è Cloud voices instead!
        </p>
      </div>

      <button class="action-btn" id="speak-btn">
        <i class="fas fa-play"></i> Generate Speech
        <div class="spinner" id="loading-spinner"></div>
      </button>

      <button class="action-btn" id="stop-btn" style="background: #ef4444; display: none;">
        <i class="fas fa-stop"></i> Stop Audio
      </button>
    </section>
  </main>

  <script type="module">
    // Optimized & Lazy Loaded
    const textInput = document.getElementById('text-input');
    const speakBtn = document.getElementById('speak-btn');
    const stopBtn = document.getElementById('stop-btn');
    const visualizer = document.getElementById('visualizer');
    const statusMsg = document.getElementById('status-msg');
    const spinner = document.getElementById('loading-spinner');
    const charCount = document.getElementById('char-count');
    const engineSelect = document.getElementById('engine-select');

    let globalAudioContext = null;
    let currentSource = null;
    let currentHtmlAudio = null;
    
    let transformersPipeline = null;
    let mmsSynthesizer = null;
    let currentMMSModel = null;
    let KokoroTTSModule = null;
    let kokoroSynthesizer = null;

    if ('caches' in window) caches.delete('transformers-cache');

    const frag = document.createDocumentFragment();
    for (let i = 0; i < 20; i++) {
      const bar = document.createElement('div');
      bar.classList.add('bar');
      frag.appendChild(bar);
    }
    visualizer.appendChild(frag);

    textInput.addEventListener('input', () => {
      const len = textInput.value.length;
      charCount.textContent = `${len} / 500`;
      charCount.style.color = len > 500 ? '#ef4444' : 'var(--text-muted)';
    });

    const yieldToBrowser = () => new Promise(resolve => setTimeout(resolve, 50));

    speakBtn.addEventListener('click', async () => {
      const text = textInput.value.trim();
      if (!text) {
        statusMsg.textContent = "Please enter some text in the box first!";
        statusMsg.style.color = '#ef4444';
        return;
      }

      speakBtn.style.display = 'none';
      stopBtn.style.display = 'flex';
      spinner.style.display = 'block';
      textInput.disabled = true;
      statusMsg.style.color = 'var(--text-muted)';

      const engine = engineSelect.value;

      try {
        // 1. ULTRA-REALISTIC (KOKORO)
        if (engine.startsWith('kokoro_')) {
          const voice = engine.replace('kokoro_', '');
          
          if (!KokoroTTSModule) {
            statusMsg.textContent = "Setting up the AI Engine...";
            await yieldToBrowser(); 
            const module = await import('https://cdn.jsdelivr.net/npm/kokoro-js@1.2.1/+esm');
            KokoroTTSModule = module.KokoroTTS;
          }

          if (!kokoroSynthesizer) {
            statusMsg.textContent = "Downloading Voice AI (~82MB)... This only happens once!";
            await yieldToBrowser(); 
            kokoroSynthesizer = await KokoroTTSModule.from_pretrained("onnx-community/Kokoro-82M-v1.0-ONNX", { dtype: "q8" });
          }

          statusMsg.textContent = "Creating ultra-realistic audio...";
          await yieldToBrowser();
          const result = await kokoroSynthesizer.generate(text, { voice: voice });
          playFloat32Audio(result.audio, result.sampling_rate);
        }
        
        // 2. FAST CLOUD VOICES (TWITCH API)
        else if (engine.startsWith('twitch_')) {
            const voice = engine.replace('twitch_', '');
            statusMsg.textContent = `Connecting to Cloud Voice...`;
            const url = `https://api.streamelements.com/kappa/v2/speech?voice=${voice}&text=${encodeURIComponent(text)}`;
            
            currentHtmlAudio = new Audio(url);
            currentHtmlAudio.onplay = () => {
                spinner.style.display = 'none';
                statusMsg.textContent = "Playing out loud...";
                visualizer.classList.add('active');
            };
            currentHtmlAudio.onended = () => { statusMsg.textContent = "Done!"; resetUI(); };
            currentHtmlAudio.onerror = () => {
                statusMsg.textContent = "‚ö†Ô∏è Network blocked the Cloud Audio.";
                statusMsg.style.color = '#ef4444';
                resetUI();
            };
            currentHtmlAudio.play();
        } 
        
        // 3. DEVICE OFFLINE VOICE
        else if (engine === 'native') {
          statusMsg.textContent = "Using basic computer voice...";
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.onstart = () => {
            spinner.style.display = 'none';
            statusMsg.textContent = "Playing out loud...";
            visualizer.classList.add('active');
          };
          utterance.onend = () => { statusMsg.textContent = "Done!"; resetUI(); };
          utterance.onerror = () => { statusMsg.textContent = "Playback Error"; resetUI(); };
          window.speechSynthesis.speak(utterance);
        } 
        
        // 4. INTERNATIONAL VOICES (MMS)
        else if (engine.startsWith('mms_')) {
          const modelId = engine.replace('mms_', '');

          if (!transformersPipeline) {
            statusMsg.textContent = "Setting up the AI Engine...";
            await yieldToBrowser();
            const module = await import('https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2');
            transformersPipeline = module.pipeline;
            module.env.allowLocalModels = false;
            module.env.useBrowserCache = true;
          }

          if (!mmsSynthesizer || currentMMSModel !== modelId) {
              statusMsg.textContent = `Downloading Language Model (~130MB)... This only happens once!`;
              await yieldToBrowser();
              mmsSynthesizer = await transformersPipeline('text-to-speech', modelId, { quantized: true });
              currentMMSModel = modelId;
          }

          statusMsg.textContent = "Creating audio...";
          await yieldToBrowser();
          const result = await mmsSynthesizer(text);
          playFloat32Audio(result.audio, result.sampling_rate);
        }

      } catch (error) {
        console.error(error);
        // Extremely simplified error message to help the user resolve the issue
        statusMsg.innerHTML = error.message.includes('fetch') || error.message.includes('Float32Array') 
            ? `‚ö†Ô∏è <b>Blocked by School Wi-Fi!</b><br>Please choose a "Fast Cloud Voice" instead.`
            : `Error: Something went wrong.`;
        statusMsg.style.color = '#ef4444';
        resetUI();
      }
    });

    stopBtn.addEventListener('click', () => {
      if (currentSource) { currentSource.stop(); currentSource = null; }
      if (currentHtmlAudio) { currentHtmlAudio.pause(); currentHtmlAudio = null; }
      window.speechSynthesis.cancel();
      statusMsg.textContent = "Audio Stopped.";
      resetUI();
    });

    function getAudioContext() {
        if (!globalAudioContext) {
            globalAudioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (globalAudioContext.state === 'suspended') {
            globalAudioContext.resume();
        }
        return globalAudioContext;
    }

    function playFloat32Audio(float32Array, sampleRate) {
      const ctx = getAudioContext();
      const buffer = ctx.createBuffer(1, float32Array.length, sampleRate);
      buffer.getChannelData(0).set(float32Array);
      
      currentSource = ctx.createBufferSource();
      currentSource.buffer = buffer;
      currentSource.connect(ctx.destination);
      
      currentSource.onended = () => { statusMsg.textContent = "Done!"; resetUI(); };
      currentSource.start();
      
      spinner.style.display = 'none';
      statusMsg.textContent = "Playing out loud...";
      visualizer.classList.add('active');
    }

    function resetUI() {
      speakBtn.style.display = 'flex';
      stopBtn.style.display = 'none';
      spinner.style.display = 'none';
      textInput.disabled = false;
      visualizer.classList.remove('active');
    }
  </script>
</body>

</html>
